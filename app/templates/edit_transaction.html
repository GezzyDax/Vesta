{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-pencil-square"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('main.transactions') }}">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a></li>
                            <li class="breadcrumb-item active">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="{{ url_for('main.transactions') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <!-- –î–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
                            <div class="col-md-6 mb-3">
                                <label for="date" class="form-label">–î–∞—Ç–∞ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="date" name="date" 
                                       value="{{ transaction.date.strftime('%Y-%m-%d') }}" required>
                            </div>
                            
                            <!-- –°—É–º–º–∞ -->
                            <div class="col-md-6 mb-3">
                                <label for="amount" class="form-label">–°—É–º–º–∞ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="amount" name="amount" 
                                           value="{{ transaction.amount }}" min="0" required>
                                    <span class="input-group-text">‚ÇΩ</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- –¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
                            <div class="col-md-6 mb-3">
                                <label for="transaction_type" class="form-label">–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ <span class="text-danger">*</span></label>
                                <select class="form-select" id="transaction_type" name="transaction_type" required>
                                    <option value="expense" {% if transaction.transaction_type == 'expense' %}selected{% endif %}>
                                        üí∏ –†–∞—Å—Ö–æ–¥
                                    </option>
                                    <option value="income" {% if transaction.transaction_type == 'income' %}selected{% endif %}>
                                        üí∞ –î–æ—Ö–æ–¥
                                    </option>
                                    <option value="transfer" {% if transaction.transaction_type == 'transfer' %}selected{% endif %}>
                                        üîÑ –ü–µ—Ä–µ–≤–æ–¥
                                    </option>
                                </select>
                            </div>
                            
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                            <div class="col-md-6 mb-3">
                                <label for="category_id" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è <span class="text-danger">*</span></label>
                                <select class="form-select" id="category_id" name="category_id" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}" 
                                                {% if transaction.category_id == category.id %}selected{% endif %}>
                                            {{ category.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                        <div class="mb-3">
                            <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="description" name="description" rows="3" 
                                      placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...">{{ transaction.description or '' }}</textarea>
                            <div class="form-text">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
                        </div>

                        <div class="row">
                            <!-- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è -->
                            <div class="col-md-6 mb-3">
                                <label for="subcategory" class="form-label">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                <input type="text" class="form-control" id="subcategory" name="subcategory" 
                                       value="{{ transaction.subcategory or '' }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–¥—É–∫—Ç—ã">
                                <div class="form-text">–£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
                            </div>
                            
                            <!-- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
                            <div class="col-md-6 mb-3">
                                <label for="contact_phone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                                <input type="tel" class="form-control" id="contact_phone" name="contact_phone" 
                                       value="{{ transaction.contact_phone or '' }}" placeholder="+7 (XXX) XXX-XX-XX">
                                <div class="form-text">–î–ª—è –°–ë–ü –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
                            </div>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-light border">
                                    <h6 class="alert-heading">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <small class="text-muted">ID:</small><br>
                                            <code>#{{ transaction.id }}</code>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">–°–æ–∑–¥–∞–Ω–∞:</small><br>
                                            {{ transaction.created_at.strftime('%d.%m.%Y %H:%M') if transaction.created_at else '–ù/–î' }}
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">–†–µ—Ñ–µ—Ä–µ–Ω—Å:</small><br>
                                            {{ transaction.reference or '–ù/–î' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                            <a href="{{ url_for('main.transactions') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="button" class="btn btn-outline-danger ms-auto" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?</strong></p>
                <div class="alert alert-warning">
                    <div class="row">
                        <div class="col-sm-4"><strong>–î–∞—Ç–∞:</strong></div>
                        <div class="col-sm-8">{{ transaction.date.strftime('%d.%m.%Y') }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>–°—É–º–º–∞:</strong></div>
                        <div class="col-sm-8">{{ "{:,.2f}".format(transaction.amount) }} ‚ÇΩ</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong></div>
                        <div class="col-sm-8">{{ transaction.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</div>
                    </div>
                </div>
                <p class="text-danger mb-0">
                    <i class="bi bi-exclamation-circle"></i> 
                    –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <form method="POST" action="{{ url_for('main.delete_transaction', transaction_id=transaction.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> –î–∞, —É–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ —Å—É–º–º—ã
document.getElementById('amount').focus();

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
function formatPhoneNumber(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.startsWith('8') && value.length === 11) {
        value = '7' + value.substring(1);
    }
    
    if (value.startsWith('7') && value.length === 11) {
        const formatted = `+7 (${value.substring(1, 4)}) ${value.substring(4, 7)}-${value.substring(7, 9)}-${value.substring(9, 11)}`;
        e.target.value = formatted;
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
document.getElementById('contact_phone').addEventListener('input', formatPhoneNumber);
</script>
{% endblock %}