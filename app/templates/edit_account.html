{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á–µ—Ç{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-bank"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á–µ—Ç</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('main.accounts') }}">–°—á–µ—Ç–∞</a></li>
                            <li class="breadcrumb-item active">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="{{ url_for('main.accounts') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å—á–µ—Ç–∞–º
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞ -->
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ account.name }}" required maxlength="100"
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞">
                                <div class="form-text">–ü–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ —Å—á–µ—Ç–∞</div>
                            </div>
                            
                            <!-- –ë–∞–Ω–∫ -->
                            <div class="col-md-6 mb-3">
                                <label for="bank" class="form-label">–ë–∞–Ω–∫ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="bank" name="bank" 
                                       value="{{ account.bank }}" required maxlength="100"
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫">
                                <div class="form-text">–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –∏–ª–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- –¢–∏–ø —Å—á–µ—Ç–∞ -->
                            <div class="col-md-6 mb-3">
                                <label for="account_type" class="form-label">–¢–∏–ø —Å—á–µ—Ç–∞ <span class="text-danger">*</span></label>
                                <select class="form-select" id="account_type" name="account_type" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                    <option value="checking" {% if account.account_type == 'checking' %}selected{% endif %}>
                                        üí≥ –†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç
                                    </option>
                                    <option value="savings" {% if account.account_type == 'savings' %}selected{% endif %}>
                                        üè¶ –°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç
                                    </option>
                                    <option value="credit" {% if account.account_type == 'credit' %}selected{% endif %}>
                                        üí∏ –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞
                                    </option>
                                    <option value="cash" {% if account.account_type == 'cash' %}selected{% endif %}>
                                        üíµ –ù–∞–ª–∏—á–Ω—ã–µ
                                    </option>
                                    <option value="investment" {% if account.account_type == 'investment' %}selected{% endif %}>
                                        üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π —Å—á–µ—Ç
                                    </option>
                                </select>
                            </div>
                            
                            <!-- –í–∞–ª—é—Ç–∞ -->
                            <div class="col-md-6 mb-3">
                                <label for="currency" class="form-label">–í–∞–ª—é—Ç–∞ <span class="text-danger">*</span></label>
                                <select class="form-select" id="currency" name="currency" required>
                                    <option value="RUB" {% if account.currency == 'RUB' %}selected{% endif %}>‚ÇΩ –†—É–±–ª–∏ (RUB)</option>
                                    <option value="USD" {% if account.currency == 'USD' %}selected{% endif %}>$ –î–æ–ª–ª–∞—Ä—ã –°–®–ê (USD)</option>
                                    <option value="EUR" {% if account.currency == 'EUR' %}selected{% endif %}>‚Ç¨ –ï–≤—Ä–æ (EUR)</option>
                                    <option value="CNY" {% if account.currency == 'CNY' %}selected{% endif %}>¬• –Æ–∞–Ω–∏ (CNY)</option>
                                    <option value="KZT" {% if account.currency == 'KZT' %}selected{% endif %}>‚Ç∏ –¢–µ–Ω–≥–µ (KZT)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <!-- –ë–∞–ª–∞–Ω—Å -->
                            <div class="col-md-6 mb-3">
                                <label for="balance" class="form-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="balance" name="balance" 
                                           value="{{ account.balance }}" required>
                                    <span class="input-group-text" id="currency-symbol">‚ÇΩ</span>
                                </div>
                                <div class="form-text">–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç–µ</div>
                            </div>
                            
                            <!-- –í–ª–∞–¥–µ–ª–µ—Ü -->
                            <div class="col-md-6 mb-3">
                                <label for="user_id" class="form-label">–í–ª–∞–¥–µ–ª–µ—Ü <span class="text-danger">*</span></label>
                                <select class="form-select" id="user_id" name="user_id" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞</option>
                                    {% for user in users %}
                                        <option value="{{ user.id }}" {% if account.user_id == user.id %}selected{% endif %}>
                                            {{ user.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–ß–ª–µ–Ω —Å–µ–º—å–∏, –≤–ª–∞–¥–µ—é—â–∏–π —ç—Ç–∏–º —Å—á–µ—Ç–æ–º</div>
                            </div>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                       {% if account.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    <strong>–ê–∫—Ç–∏–≤–Ω—ã–π —Å—á–µ—Ç</strong>
                                </label>
                                <div class="form-text">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—á–µ—Ç–∞ —Å–∫—Ä—ã—Ç—ã –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                            </div>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—á–µ—Ç–µ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-light border">
                                    <h6 class="alert-heading">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—á–µ—Ç–µ:</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <small class="text-muted">ID:</small><br>
                                            <code>#{{ account.id }}</code>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">–°–æ–∑–¥–∞–Ω:</small><br>
                                            {{ account.created_at.strftime('%d.%m.%Y %H:%M') if account.created_at else '–ù/–î' }}
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:</small><br>
                                            {% if account.transactions %}
                                                {{ account.transactions|selectattr('date')|list|sort(attribute='date', reverse=true)|first|attr('date')|strftime('%d.%m.%Y') }}
                                            {% else %}
                                                –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                            <a href="{{ url_for('main.accounts') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="button" class="btn btn-outline-danger ms-auto" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å—á–µ—Ç?</strong></p>
                <div class="alert alert-warning">
                    <div class="row">
                        <div class="col-sm-4"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong></div>
                        <div class="col-sm-8">{{ account.name }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>–ë–∞–Ω–∫:</strong></div>
                        <div class="col-sm-8">{{ account.bank }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>–ë–∞–ª–∞–Ω—Å:</strong></div>
                        <div class="col-sm-8">{{ "{:,.2f}".format(account.balance) }} {{ account.currency }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:</strong></div>
                        <div class="col-sm-8">{{ account.transactions|length }}</div>
                    </div>
                </div>
                <p class="text-danger mb-0">
                    <i class="bi bi-exclamation-circle"></i> 
                    –£–¥–∞–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —É–¥–∞–ª–µ–Ω–∏—é –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <form method="POST" action="{{ url_for('main.delete_account', account_id=account.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> –î–∞, —É–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
document.getElementById('name').focus();

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ –≤–∞–ª—é—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–∞–ª—é—Ç—ã
document.getElementById('currency').addEventListener('change', function() {
    const currencySymbol = document.getElementById('currency-symbol');
    const currencies = {
        'RUB': '‚ÇΩ',
        'USD': '$',
        'EUR': '‚Ç¨',
        'CNY': '¬•',
        'KZT': '‚Ç∏'
    };
    currencySymbol.textContent = currencies[this.value] || '‚ÇΩ';
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞
document.getElementById('balance').addEventListener('input', function() {
    const value = parseFloat(this.value);
    if (value < 0) {
        this.setCustomValidity('–ë–∞–ª–∞–Ω—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
    } else {
        this.setCustomValidity('');
    }
});

// –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
document.getElementById('user_id').addEventListener('change', function() {
    const originalUserId = {{ account.user_id }};
    if (this.value != originalUserId) {
        const warning = document.createElement('div');
        warning.className = 'alert alert-warning mt-2';
        warning.innerHTML = '<i class="bi bi-exclamation-triangle"></i> –í–Ω–∏–º–∞–Ω–∏–µ! –°–º–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å—á–µ—Ç–∞ –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.';
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingWarning = this.parentNode.querySelector('.alert-warning');
        if (existingWarning) {
            existingWarning.remove();
        }
        
        this.parentNode.appendChild(warning);
    } else {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞
        const warning = this.parentNode.querySelector('.alert-warning');
        if (warning) {
            warning.remove();
        }
    }
});
</script>
{% endblock %}