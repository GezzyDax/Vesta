{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-tag"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('main.categories') }}">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a></li>
                            <li class="breadcrumb-item active">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="{{ url_for('main.categories') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       required maxlength="100" value="{{ category.name }}">
                                <div class="form-text">–ö—Ä–∞—Ç–∫–æ–µ, –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                            </div>

                            <!-- –¢–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                            <div class="col-md-6 mb-3">
                                <label for="category_type" class="form-label">–¢–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ <span class="text-danger">*</span></label>
                                <select class="form-select" id="category_type" name="category_type" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                    <option value="income" {% if category.category_type == 'income' %}selected{% endif %}>
                                        üí∞ –î–æ—Ö–æ–¥
                                    </option>
                                    <option value="expense" {% if category.category_type == 'expense' %}selected{% endif %}>
                                        üí∏ –†–∞—Å—Ö–æ–¥
                                    </option>
                                    <option value="transfer" {% if category.category_type == 'transfer' %}selected{% endif %}>
                                        üîÑ –ü–µ—Ä–µ–≤–æ–¥
                                    </option>
                                </select>
                                <div class="form-text">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                            </div>
                        </div>

                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                        <div class="mb-3">
                            <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="description" name="description" rows="3" 
                                      maxlength="255" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...">{{ category.description or '' }}</textarea>
                            <div class="form-text">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                       {% if category.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    <strong>–ê–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</strong>
                                </label>
                                <div class="form-text">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–∫—Ä—ã—Ç—ã –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                            </div>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-light border">
                                    <h6 class="alert-heading">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <small class="text-muted">ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</small><br>
                                            <code>#{{ category.id }}</code>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:</small><br>
                                            {% set transaction_count = category.transactions|length %}
                                            <span class="badge bg-primary">{{ transaction_count }}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">–ü—Ä–∞–≤–∏–ª –º–µ—Ä—á–∞–Ω—Ç–æ–≤:</small><br>
                                            {% set rule_count = category.merchant_rules|length %}
                                            <span class="badge bg-info">{{ rule_count if rule_count else 0 }}</span>
                                        </div>
                                    </div>
                                    {% if transaction_count > 0 %}
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:</small><br>
                                            {% set last_transaction = category.transactions|selectattr('date')|list|sort(attribute='date', reverse=true)|first %}
                                            {% if last_transaction %}
                                                {{ last_transaction.date.strftime('%d.%m.%Y') }}
                                            {% else %}
                                                –ù/–î
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">–û–±—â–∞—è —Å—É–º–º–∞:</small><br>
                                            {% set total_amount = category.transactions|sum(attribute='amount') %}
                                            {{ "{:,.2f}".format(total_amount).replace(',', ' ') }} ‚ÇΩ
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
                        {% if transaction_count > 0 %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –° —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π —Å–≤—è–∑–∞–Ω–æ {{ transaction_count }} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. 
                            –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –æ—Ç—á–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É.
                        </div>
                        {% endif %}

                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                            <a href="{{ url_for('main.categories') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="button" class="btn btn-outline-danger ms-auto" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é?</strong></p>
                <div class="alert alert-warning">
                    <div class="row">
                        <div class="col-sm-4"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong></div>
                        <div class="col-sm-8">{{ category.name }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>–¢–∏–ø:</strong></div>
                        <div class="col-sm-8">
                            {% if category.category_type == 'income' %}üí∞ –î–æ—Ö–æ–¥
                            {% elif category.category_type == 'expense' %}üí∏ –†–∞—Å—Ö–æ–¥
                            {% else %}üîÑ –ü–µ—Ä–µ–≤–æ–¥
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:</strong></div>
                        <div class="col-sm-8">{{ category.transactions|length }}</div>
                    </div>
                </div>
                
                {% if category.transactions|length > 0 %}
                <p class="text-danger mb-0">
                    <i class="bi bi-exclamation-circle"></i> 
                    <strong>–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏!</strong> –°–Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–ª–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
                </p>
                {% else %}
                <p class="text-danger mb-0">
                    <i class="bi bi-exclamation-circle"></i> 
                    –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!
                </p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                {% if category.transactions|length == 0 %}
                <form method="POST" action="{{ url_for('main.delete_category', category_id=category.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> –î–∞, —É–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
                {% else %}
                <button type="button" class="btn btn-danger" disabled>
                    <i class="bi bi-slash-circle"></i> –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
document.getElementById('name').focus();

// –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
const originalType = "{{ category.category_type }}";
document.getElementById('category_type').addEventListener('change', function() {
    if (this.value !== originalType && {{ category.transactions|length }} > 0) {
        const warning = document.createElement('div');
        warning.className = 'alert alert-warning mt-2';
        warning.innerHTML = '<i class="bi bi-exclamation-triangle"></i> –í–Ω–∏–º–∞–Ω–∏–µ! –°–º–µ–Ω–∞ —Ç–∏–ø–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ {{ category.transactions|length }} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.';
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingWarning = this.parentNode.querySelector('.alert-warning');
        if (existingWarning && existingWarning !== document.querySelector('.alert.alert-warning')) {
            existingWarning.remove();
        }
        
        if (this.value !== originalType) {
            this.parentNode.appendChild(warning);
        }
    } else {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–∏–ø
        const warning = this.parentNode.querySelector('.alert-warning');
        if (warning && warning !== document.querySelector('.alert.alert-warning')) {
            warning.remove();
        }
    }
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const categoryType = document.getElementById('category_type').value;
    
    if (!name) {
        e.preventDefault();
        document.getElementById('name').focus();
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        return;
    }
    
    if (!categoryType) {
        e.preventDefault();
        document.getElementById('category_type').focus();
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        return;
    }
    
    if (name.length < 2) {
        e.preventDefault();
        document.getElementById('name').focus();
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
        return;
    }
});

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
document.getElementById('is_active').addEventListener('change', function() {
    if (!this.checked && {{ category.transactions|length }} > 0) {
        if (!document.querySelector('.deactivation-warning')) {
            const warning = document.createElement('div');
            warning.className = 'alert alert-info mt-2 deactivation-warning';
            warning.innerHTML = '<i class="bi bi-info-circle"></i> –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∫—Ä–æ–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Å–ø–∏—Å–∫–æ–≤ –≤—ã–±–æ—Ä–∞, –Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.';
            this.parentNode.appendChild(warning);
        }
    } else {
        const warning = document.querySelector('.deactivation-warning');
        if (warning) {
            warning.remove();
        }
    }
});
</script>
{% endblock %}